---
title: "Data extraction description"
author:
  - name: Luke W. Johnston
    url: https://lukewjohnston.com/
    affiliation: Steno Diabetes Center Aarhus
repository_url: https://gitlab.com/lwjohnst/meld-dst-application/
creative_commons: CC BY
---

Your extract description must consist of the following points:

- Place of treatment
- Population
- Data connection
- Justification for the requested data

## Data access and user on the Research Machine

We do not need access to a research machine, we have a project at DST.

## Treatment site

We want the data to be transferred to our project on the DST research server.

## Population

In order to identify familial relations through individuals' life course
trajectory, the population requested covers all individuals, who live or lived
in Denmark from 1 January 1970 to 31 December 2020 (~8.5 million people). The
family linkage and structure makes the construction of the population
complicated, which we will do ourselves. For that we need the entire population
because we need data on not just the individual, but also the family (parents
and siblings). To characterise early life and early childhood conditions of an
individual person, we need data on their parents. Likewise, to understand the
role that the family network, including siblings and grandparents, has on
diabetes risk, we need a large enough population to make these linkages and to
adequately study this area.

To create the family structure and linkages, we need:

- All index individuals born or who migrated into Denmark on or after 1970-01-01.
- All family members of the index individuals, including parents, siblings,
spouses, and children.
- Registers and variables:  
    - BEF: AEGTE_ID, CIVST, CIV_VFRA, E_FAELLE_ID, FAR_ID, MOR_ID, PNR,
    FOED_DAG, KOEN, OPR_LAND.
    - CPST: AEGTEFAELLE_ID, CIVST, CIV_DATO, FAR_ID, MOR_ID, PNR.

Combining BEF and CPST has, from our previous experience and projects, resulted
in better coverage in creating our study population than one register alone.

The population has been created by DST.

## Data connection

You must specify what data you want to access for the population you have specified.

Data must as a minimum be delimited on the basis of the following parameters:

- Which registers
- Which tables
- Which variables
- What time period

```{r list-registers-needed, include=FALSE}
library(tidyverse)
library(here)
sds_variables <- read_csv(here("data/sds-registers-with-variables-to-use.csv"))
sds_variables <- sds_variables %>% 
    filter(use_in_application == 1) %>% 
    mutate(start_year = str_extract(periode, "^\\d{4}"),
           time_period = str_c(start_year, " to 2020")) %>% 
    select(register_name, table_name, variable_name, time_period)

random_registers <- read_csv(here("data/random-undocumented.csv")) %>% 
    mutate(time_period = str_c(start_year, " to ", end_year)) %>% 
    select(register_name, table_name = register_table_name, variable_name,
           time_period)

registers <- bind_rows(sds_variables, random_registers)

# TODO: Filter registers to those that are on SDS, including LMBD and others?
```

```{r}
header_and_table_as_md <- function(data) {
    header <- unique(data$register_name)
    
    table <- data %>% 
        select(-register_name) %>% 
        select(where(~all(!is.na(.x)))) %>% 
        knitr::kable() %>% 
        as.character()
    
    c("", glue::glue("## {header}"), "", table, "")
}

registers %>% 
    group_split(register_name) %>% 
    map(header_and_table_as_md) %>% 
    unlist() %>% 
    cat(sep = "\n")
```

## Justification for the requested data

We ask you to briefly describe how the desired data can be used to answer the project's problem.

This is to ensure that you as a researcher have access to data that is both necessary and sufficient for your project.


