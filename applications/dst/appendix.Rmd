---
output: 
    word_document: 
        reference_docx: "templates/appendix.docx"
---

Danmarks Statistik, Forskningsservice       `r lubridate::stamp("March 13, 1999")(lubridate::today())`  
Generel Forskningsservice   
        Projektnr. <xxxxxx

Luke W. Johnston, Steno Diabetes Center Aarhus

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(glue)
library(flextable)
needed_registers <- here("data/needed-registers.csv") %>% 
    read_csv(col_types = "lddccccc") %>% 
    filter(!drop | is.na(drop))

dst_variables <- read_csv(here("data/dst-registers-with-variables-to-use.csv"))
dst_variables <- dst_variables %>%
    filter(use_in_application == 1,
           register_id %in% unique(needed_registers$register_id)) %>% 
    mutate(across(ends_with("year"), str_extract, pattern = "^\\d{4}")) %>% 
    mutate(
        start_year = case_when(
            is.na(variable_start_year) |
                variable_start_year == variable_end_year ~
                register_start_year,
            TRUE ~ variable_start_year
        ),
        year_range = glue::glue("{start_year} - {variable_end_year}")
    ) %>% 
    select(register_id, register_name_dk, variable_name, year_range, description_dk)

sds_variables <- read_csv(here("data/sds-registers-with-variables-to-use.csv"))
sds_variables <- sds_variables %>% 
    filter(use_in_application == 1) %>% 
    # mutate(start_year = str_extract(periode, "^\\d{4}")) %>% 
    mutate(periode = str_replace(periode, "\\s?-\\s?$", "-Latest")) %>% 
    select(register_name, table_name, variable_name, periode, variablebeskrivelse)

random_registers <- read_csv(here("data/random-undocumented.csv")) %>% 
    mutate(
        start_year = if_else(is.na(start_year), "Earliest", as.character(start_year)),
        year_range = glue::glue("{start_year} - {end_year}")
    )

knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = "")
```

```{r functions, include=FALSE}
format_dst_appendix_table <- function(data) {
    data %>%
        dplyr::select(Variables, Beskrivelse, År) %>%
        flextable::flextable() %>%
        flextable::add_header_row(values = c("Grundregisternavn",
                                             unique(data$register_id),
                                             "")) %>%
        flextable::border_remove() %>%
        flextable::hline_top(border = officer::fp_border(color = "black"),
                             part = "all") %>%
        flextable::hline_bottom(border = officer::fp_border(color = "black"),
                                part = "body") %>%
        flextable::bold(part = "header") %>%
        flextable::color(color = "white", part = "header") %>%
        flextable::valign(valign = "top", part = "header") %>%
        flextable::bg(bg = "#4f81bd", part = "header") %>% 
        flextable::font(fontname = "Times New Roman", part = "all") %>% 
        flextable::fontsize(size = 12, part = "all") %>% 
        flextable::width(width = 2.25)
}

format_non_dst_appendix_table <- function(data, caption = NULL, width = 2.25, is_atc = FALSE) {
    bold_atc <- function(tbl) {
        tbl %>% 
            flextable::bold(
                i = ~str_detect(`ATC Code`, "^[A-N]$"),
                j = ~Description + `ATC Code`
            )
    }
    data %>%
        flextable::flextable() %>%
        # flextable::add_header_row(values = c("Registernavn",
        #                                      unique(data$register_name),
        #                                      "")) %>%
        flextable::border_remove() %>%
        flextable::hline_top(border = officer::fp_border(color = "black"),
                             part = "all") %>%
        flextable::hline_bottom(border = officer::fp_border(color = "black"),
                                part = "body") %>%
        {if (is_atc) {bold_atc(.)} else {.}} %>% 
        flextable::bold(part = "header") %>%
        flextable::color(color = "white", part = "header") %>%
        flextable::valign(valign = "top", part = "header") %>%
        flextable::bg(bg = "#4f81bd", part = "header") %>% 
        flextable::font(fontname = "Times New Roman", part = "all") %>% 
        flextable::fontsize(size = 12, part = "all") %>% 
        flextable::width(width = width) %>% 
        {if (!is.null(caption)) {flextable::set_caption(., caption = caption)} else {.}} %>% 
        {if (interactive()) {.} else {flextable::flextable_to_rmd(text_after = "\\pagebreak")}}
}

icd_as_table <- function(data, group, caption, width = c(1.5, 2.5, 1.75, 1.75)) {
    data %>%
        filter(parent_group == group) %>%
        select(-parent_group) %>%
        format_non_dst_appendix_table(caption = caption, width = width)
}

```

## Projekttitel og -nr

Interplay between diabetes and intergenerational transmission of health determinants over the life course

## Populations afgrænsning(er)

<!-- Skriv her en beskrivelse af populationen -->

In order to identify familial relations through individuals' life course trajectory,
the population requested covers all individuals, who live or lived in Denmark 
from 1 January 1970 to 31 December 2020 (~8.5 million people). Key requirements are:

- All index individuals born or who migrated into Denmark on or after 1970-01-01.
- All family members of the index individuals, including parents, siblings,
spouses, and children.

## List of registers and variables from DST

```{r requested-dst-variable-tables, results='asis'}
variable_tables <- dst_variables %>% 
    mutate(register_name = glue("{register_name_dk} ({register_id})")) %>% 
    select(-register_name_dk) %>% 
    rename(Variables = variable_name, Beskrivelse = description_dk, År = year_range) %>% 
    group_split(register_name) 

for (variable_table in variable_tables) {
    register <- unique(variable_table$register_name)
    # Register name as header
    glue("\n\n## Grundregisternavn: {register}\n\n") %>% 
        as.character() %>% 
        cat()
    
    # Variables as table
    variable_table %>% 
        format_dst_appendix_table() %>% 
        flextable_to_rmd(text_after = "\\pagebreak")
}
```

## List of registers and variables from external sources

```{r requested-non-dst-variable-tables, results='asis'}
sds_variable_tables <- sds_variables %>% 
    rename(
        Tabel = table_name,
        Variabler = variable_name, 
        Beskrivelse = variablebeskrivelse,
        År = periode
    ) %>% 
    filter(register_name == "Det Nationale Diabetesregister")

register <- unique(sds_variable_tables$register_name)
# Register name as header
glue("\n\n## {register}\n\n") %>%
    as.character() %>%
    cat()

# Variables as table
sds_variable_tables %>%
    dplyr::select(matches("^Tabel$"), Variabler, Beskrivelse, År) %>% 
    format_non_dst_appendix_table(width = c(1.5, 1.5, 3, 1.5))
```

```{r requested-random-registers-variable-tables, results='asis'}
random_variable_tables <- random_registers %>% 
    select(register_name, register_table_name, variable_name, 
           year_range, variable_description_dk) %>% 
    rename(
        Tabel = register_table_name,
        Variabler = variable_name, 
        Beskrivelse = variable_description_dk,
        År = year_range
    ) %>% 
    group_split(register_name) 

for (variable_table in random_variable_tables) {
    register <- unique(variable_table$register_name)
    # Register name as header
    glue("\n\n## {register}\n\n") %>% 
        as.character() %>% 
        cat()
    
    width <- c(1.5, 1.5, 3, 1.5)
    if (all(is.na(unique(variable_table$Tabel)))) {
        width <- 2.25
        variable_table <- variable_table %>% 
            select(-Tabel)
    }
    
    # Variables as table
    variable_table %>% 
        dplyr::select(matches("^Tabel$"), Variabler, Beskrivelse, År) %>% 
        format_non_dst_appendix_table(width = width)
}
```

## Labka

For alle individer i databasen ønskes der laboratorie udtræk af følgene
NPU/DNK-koder så langt tilbage i tiden som muligt.

```{r labka-data-source, results='asis'} 
here("data/labka.csv") %>%
    read_csv(col_types = cols(
        Komponent = col_character(),
        Kode = col_character(),
        Enhed = col_character()
    )) %>% 
    group_by(Komponent) %>% 
    mutate(Komponent = if_else(row_number() == 1, Komponent, "")) %>% 
    format_non_dst_appendix_table()
    # knitr::kable(caption = "Components and codes from the Labka database.")
```

## List of requested ICD-8 and -10 codes

Da hovedformålet med projektet er at undersøge prævalensen og incidensen af
diabetes, relaterede kardiometaboliske sygdomme samt følgesygdomme
(komplikationer) i sociale netværk ønsker vi nedenstående ICD10 samt ICD8 koder.
Efter koderne har vi kort redegjort for, hvorfor vi ansøger om netop de listede
koder.

```{r icd-codes-tables, results='asis'}
icd_codes <- here("data/icd-codes.csv") %>%
    read_csv(
        col_types = cols(
            parent_group = col_character(),
            Sygdomsgruppe = col_character(),
            Sygdomme = col_character(),
            ICD10 = col_character(),
            ICD8 = col_character()
        )
    )

icd_as_table(
    icd_codes,
    "diabetes",
    "Diagnosis of diabetes and its forms and subtypes."
)

icd_as_table(
    icd_codes,
    "comorbidity",
    "Diseases that contribute to, are associated with, or are complications or comorbidities of diabetes."
)

icd_as_table(
    icd_codes %>% select(-Sygdomsgruppe),
    "charlesons",
    "Diseases that are components of the 'Charleson's Morbidity Index'.",
    width = 2.25
)
```

## Justification for requested disease codes

The overall aim of this project is to identify the contributions of family and
early life determinants on the development, management and care of diabetes and
the diseases that may arise following a diabetes diagnosis, under a life-course
framework. The justification for requesting data on multiple disease areas
directly follows the primary aim of this project.   We investigate this aim
focusing on diabetes as the central disease of interest. Diabetes consists of
different subtypes (Type 1, Type 2, LADA, MODY, gestational diabetes, secondary
diabetes, rare monogenic forms) each with a different set of risk factors,
presentation and pathophysiological characteristics. The familial and social
effects that are the subject of this project are likely to be different for each
of these diabetes subtypes. E.g. for some types of diabetes, caused
predominantly by auto-immune mechanisms, familial associations to other
auto-immune diseases are more likely than for type 2 diabetes, which is driven
to a strong degree by obesity, low physical activity and insulin resistance.

All forms of diabetes have an increased blood glucose level as their central
hallmark, and are associated with major and minor complications. The vascular
complications are generally subdivided into large-vessel disease
(macrovascular): myocardial infarction, stroke, peripheral vascular disease; and
small-vessel disease (diabetic retinopathy, neuropathy nephropathy). The
occurrence of these complications is not dependent solely on the elevated
glucose levels, but also on disturbance of other metabolic risk factors,
familial predisposition and pre-existing conditions. Beyond these classical
complications, increasingly links between diabetes and other complications are
being recognised: depression, cancer, loss of cognitive function, skin
conditions.

An important feature of diabetes is that it can be undetected for several years,
and that the diabetic complications can sometimes be the first presentation of
the disease. In order to study the occurrence of diabetic complications in the
context of family we need to assess the complication status for all traditional
and novel diabetic complication.

Adequate treatment of diabetes depends on long-term engagement and motivation of
the patient for self-management of different aspects of the disease. The
capacity to respond adequately to this challenge depends to a large degree on
socio-economic status, including the degree of social support in the direct
environment surrounding the patient. These effects occur in interaction with
other chronic conditions, including mental health conditions.

The justification for the requested list of conditions falls into four categories:

1. Diagnosis of diabetes itself, in all its forms and subtypes.
2. Conditions that are an established cause of diabetes, and diseases which have
an emerging association with diabetes, which we wish to investigate
3. Major and minor complications and other consequences / signs of diabetes
4. Conditions needed to adjust our analyses for the simultaneous occurrence of
other chronic health problems (co-morbidity)
    
Description of disease and its relation to diabetes 

- **Cardiovascular disease** is the most common cause of death and disability
among people with diabetes The cardiovascular diseases that accompany diabetes
include angina, myocardial infarction (heart attack), stroke, peripheral artery
disease and congestive heart failure. High blood pressure, high cholesterol,
high blood glucose and other risk factors contribute to the increased risk of
cardiovascular complications.

- **Eye diseases:** Diabetic retinopathy and macular edema are the major eye
complications of diabetes; but diabetic eye disease also includes cataract and
glaucoma. Furthermore, infections of the eyelid and adnexa are also seen.

- **Neurological and neurodegenerative diseases:** Diabetic peripheral and autonomic
neuropathy are part of the major diabetic microvascular complications.
Furthermore, diabetes has long been linked to vascular dementia; probably
mediated through chronic ischaemia, endothelial dysfunction and micro-strokes.
In the past decade, increasing evidence has emerged for a shared
pathophysiological and aetiological connection between diabetes and Parkinson's
disease, Alzheimer's disease, dementia, loss of cognitive function.

- **Mental health conditions** have been linked to diabetes in different ways.
The most established link is between depression and diabetes, both as a cause
and a consequence, but also an association with schizophrenia has been observed
and is receiving increasing attention. Mental health can deteriorate as a
consequence of living with diabetes, and poor mental health, including
personality and eating disorders can impair a patient's ability to cope
adequately with the demands (changes in lifestyle, self-measurement and
management, self-care) posed by the presence of long-standing diabetes.
Consequently, patients with co-morbid diabetes and mental health problems tend
to have worse control and outcomes for both conditions. Moreover, mental health
conditions also affect people's abilities to build up and maintain social
connections, and they may place strain on family relations, potentially altering
their influence on health compared to the general population.

- **Orodental health:** There is a well-established link between diabetes and
orodental health. Diabetes is a risk factor for periodontal diseases such as
gingivitis and periodontitis, and the relation is though to be bidirectional,
meaning that not only does diabetes increase the occurrence of orodental
problems, but also that orodental conditions may affect the metabolic control
of diabetes in diabetic patients.
    
- **Fractures** are associated with diabetes both directly and indirectly (as a
consequence of loss of eyesight or loss of sensation in the feet due to diabetic
retinopathy and neuropathy). Moreover, fractures, especially in the elderly are
a strong cause of co-morbidity and can exacerbate other chronic health problems.

- **Gastro-intestinal diseases:**
    - Diabetes is ultimately a disease of imbalance in the carbohydrate
    metabolism, and is closely linked to lipid metabolism. Besides the
    liver, there is an increasing insight that the gut plays an important
    regulatory role. Several mechanisms linked to appetite and satiety have
    been found to be regulated in feed-back loops involving the gut
    (particularly the duodenum). This is expressed in the marked improvement in
    metabolic control seen in patients with diabetes who undergo Roux-en-Y
    gastric bypass operations and the impact on obesity of a Glucagon-like
    peptide-1 analogues.
    - Another emerging line of research linking the health of the gut to
    diabetes is the study of the intestinal microbiome. This emerging field is
    showing increasingly convincing associations between diet, the composition
    of the bacterial populations in the gut and obesity, CVD and
    several metabolic diseases including diabetes. It follows that any
    condition that causes gut inflammation, and malabsorption, such as Irritable
    Bower Syndrome, Crohn’s disease or gastric and duodenal ulcers, may affect
    the intestinal microflora, and through that mechanism diabetes risk.
    - Existing diabetes can also cause gut symptoms; patients with severely
    disregulated diabetes sometimes present with gastroparesis and constipation,
    which can be seen as a consequence of failed autonomic regulation of gut
    motility due to diabetic autonomic neuropathy.

- **Liver diseases:** Insulin resistance, a central determinant of type 2
diabetes, is principally determined by insulin resistance in the muscles
(peripheral) and in the liver (central). Diseases that affect liver function,
through inflammation, fat accumulation, fibrosis or a combination of these
mechanisms, have an impact of central insulin resistance. This phenomenon is
recognised in the strong relationship between Non-Alcoholic Fatty Liver Disease
(NAFLD) and Non-Alcoholic Steatohepatitis (NASH) with diabetes and the metabolic
syndrome. The central role of the liver, and liver conditions, to diabetes, also
provides a conceptual link to other metabolic conditions in which the liver
plays a central role, such as iron and lipid metabolism.

- **Kidney diseases:** Diabetic kidney disease is one of the main microvascular
complications of diabetes, progressing from a mild initial presentation
(micro-albuminuria) to advanced (macro-albuminuria) and late stages (end-stage
renal disease, ultimately with renal failure and the need for dialysis). Loss of
renal function itself (both in the presence and absence of diabetes) is
recognised as a risk factor for the development of cardiovascular disease.
Diabetic kidney disease thus also provides a direct pathophysiological link to
the management of hypertension in people with diabetes.

- **Anaemia and Iron metabolism:** Iron metabolism has long been implicated as a
causal factor in cardiovascular disease aetiology, but there is mounting
evidence pointing to a causal link the occurrence of diabetes. Low iron stores
and iron deficiency anaemia can have an impact on the ability to use HbA1c as a
valid indicator of average glucose levels over a longer period of time.  Anaemia
is also a strong indicator of general ill health and should be considered when
studying diabetes in a context of multi-morbidity.

- **Skin diseases:** Several dermatological conditions, including psoriasis,
dermatitis and eczema, are seen more frequently in patients with diabetes.
Peripheral neuropathy affects the skin's ability to activate sweat glands,
leading to dry and brittle skin and higher occurrence of skin infections, which
exacerbate diabetic foot problems.

- **Infertility:** Fertility problems are well known for women with diabetes
and male infertility is a likely but less studied consequence of diabetes.

## List of requested ATC codes

```{r atc-code-table, results='asis'}
here("data/atc-codes.csv") %>%
    read_csv(col_types = cols(
        level = col_double(),
        code = col_character(),
        description = col_character()
    )) %>% 
    select(`ATC Code` = code, Description = description) %>% 
    format_non_dst_appendix_table(caption = "Requested ATC codes in classifying diabetes and cardiovascular diseases.", width = c(2, 5), is_atc = TRUE)
```

